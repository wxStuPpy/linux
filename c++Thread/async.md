### 1. `std::async` - **æœ€é«˜çº§æŠ½è±¡**
#### æ ¸å¿ƒç‰¹ç‚¹ï¼š
- **è‡ªåŠ¨ç®¡ç†çº¿ç¨‹**ï¼šè‡ªåŠ¨åˆ›å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼ˆå–å†³äºå¯åŠ¨ç­–ç•¥ï¼‰
- **ç›´æ¥è¿”å› future**ï¼šä¸€æ­¥åˆ°ä½è·å–ç»“æœå®¹å™¨
- **æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼**ï¼šéšè—äº†åº•å±‚ç»†èŠ‚

```cpp
#include <future>
#include <iostream>

int compute() {
    // è€—æ—¶è®¡ç®—...
    return 42;
}

int main() {
    // å¯åŠ¨å¼‚æ­¥ä»»åŠ¡å¹¶è·å– future
    auto fut = std::async(std::launch::async, compute);
    
    // è·å–ç»“æœï¼ˆé˜»å¡ç›´åˆ°å®Œæˆï¼‰
    int result = fut.get();
    std::cout << "Result: " << result << std::endl;
}
```

#### å¯åŠ¨ç­–ç•¥ï¼š
| ç­–ç•¥                   | è¡Œä¸º                             |
|------------------------|----------------------------------|
| `std::launch::async`   | å¼ºåˆ¶åœ¨æ–°çº¿ç¨‹æ‰§è¡Œ                 |
| `std::launch::deferred` | å»¶è¿Ÿæ‰§è¡Œï¼ˆè°ƒç”¨ get() æ—¶æ‰§è¡Œï¼‰    |
| é»˜è®¤ï¼ˆæ— æŒ‡å®šï¼‰         | ç”±å®ç°å†³å®š                       |

---

### 2. `std::packaged_task` - **ä»»åŠ¡åŒ…è£…å™¨**
#### æ ¸å¿ƒç‰¹ç‚¹ï¼š
- **å¯è°ƒç”¨å¯¹è±¡åŒ…è£…å™¨**ï¼šå°†å‡½æ•°/å¯è°ƒç”¨å¯¹è±¡ä¸ promise ç»‘å®š
- **æ‰‹åŠ¨æ§åˆ¶æ‰§è¡Œæ—¶æœº**ï¼šå¯åœ¨ä»»æ„çº¿ç¨‹è°ƒç”¨
- **å¯å¤šæ¬¡ä½¿ç”¨**ï¼ˆéœ€è¦é‡æ–°æ„é€ ï¼‰

```cpp
#include <future>
#include <thread>
#include <iostream>

int main() {
    // åŒ…è£…ä»»åŠ¡ï¼ˆæœªæ‰§è¡Œï¼‰
    std::packaged_task<int()> task([]{ return 7 * 6; });
    
    // è·å–å…³è”çš„ future
    std::future<int> fut = task.get_future();
    
    // åœ¨ç‹¬ç«‹çº¿ç¨‹æ‰§è¡Œä»»åŠ¡
    std::thread t(std::move(task));
    t.detach();  // æˆ– t.join()
    
    // è·å–ç»“æœ
    std::cout << "6*7 = " << fut.get() << std::endl;
}
```

#### å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š
- çº¿ç¨‹æ± ä»»åŠ¡é˜Ÿåˆ—
- å»¶è¿Ÿæ‰§è¡Œæ§åˆ¶
- éœ€è¦é‡å¤ä½¿ç”¨ä»»åŠ¡æ¨¡æ¿

---

### 3. `std::promise` - **æœ€ä½çº§æ§åˆ¶**
#### æ ¸å¿ƒç‰¹ç‚¹ï¼š
- **æ˜¾å¼å€¼è®¾ç½®**ï¼šæ‰‹åŠ¨è®¾ç½®ç»“æœå€¼æˆ–å¼‚å¸¸
- **å®Œå…¨æ§åˆ¶æƒ**ï¼šå¯åœ¨ä»»æ„ä½ç½®è®¾ç½®ç»“æœ
- **è·¨çº¿ç¨‹é€šä¿¡**ï¼šè§£è€¦ç»“æœç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…

```cpp
#include <future>
#include <thread>
#include <iostream>

void worker(std::promise<int> result_promise) {
    try {
        // æ‰§è¡Œè®¡ç®—...
        result_promise.set_value(42);  // æ˜¾å¼è®¾ç½®ç»“æœ
    } catch(...) {
        // æ•è·å¼‚å¸¸å¹¶ä¼ é€’
        result_promise.set_exception(std::current_exception());
    }
}

int main() {
    std::promise<int> prom;
    std::future<int> fut = prom.get_future();
    
    // ä¼ é€’ promise ç»™å·¥ä½œçº¿ç¨‹
    std::thread t(worker, std::move(prom));
    
    // è·å–ç»“æœ
    std::cout << "Result: " << fut.get() << std::endl;
    t.join();
}
```

#### å…³é”®èƒ½åŠ›ï¼š
- åˆ†ç¦»ç»“æœè®¾ç½®ç‚¹ï¼ˆå¯åœ¨ä¸åŒå‡½æ•°/çº¿ç¨‹è®¾ç½®ç»“æœï¼‰
- æ”¯æŒè®¾ç½®å¼‚å¸¸ï¼š`set_exception()`
- å¯åˆ›å»º void ç‰¹åŒ–ç‰ˆï¼ˆæ— è¿”å›å€¼çš„äº‹ä»¶é€šçŸ¥ï¼‰

---

### ä¸‰è€…çš„æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”
| ç‰¹æ€§                     | `std::async`               | `std::packaged_task`       | `std::promise`             |
|--------------------------|----------------------------|----------------------------|----------------------------|
| **æŠ½è±¡å±‚çº§**             | é«˜çº§ï¼ˆå…¨è‡ªåŠ¨ï¼‰             | ä¸­çº§ï¼ˆåŠè‡ªåŠ¨ï¼‰             | ä½çº§ï¼ˆæ‰‹åŠ¨æ§åˆ¶ï¼‰           |
| **çº¿ç¨‹ç®¡ç†**             | è‡ªåŠ¨åˆ›å»ºçº¿ç¨‹               | éœ€æ‰‹åŠ¨å¯åŠ¨                 | å®Œå…¨æ‰‹åŠ¨æ§åˆ¶               |
| **ç»“æœè®¾ç½®æ–¹å¼**         | è‡ªåŠ¨ï¼ˆå‡½æ•°è¿”å›å€¼ï¼‰         | è‡ªåŠ¨ï¼ˆè°ƒç”¨ä»»åŠ¡æ—¶ï¼‰         | æ‰‹åŠ¨è°ƒç”¨ `set_value()`     |
| **ä»»åŠ¡æ‰§è¡Œæ§åˆ¶**         | æœ‰é™ï¼ˆé€šè¿‡å¯åŠ¨ç­–ç•¥ï¼‰       | å®Œå…¨æ§åˆ¶ï¼ˆä½•æ—¶è°ƒç”¨ä»»åŠ¡ï¼‰   | å®Œå…¨æ§åˆ¶ï¼ˆä½•æ—¶è®¾ç½®ç»“æœï¼‰   |
| **å¼‚å¸¸ä¼ é€’**             | è‡ªåŠ¨æ•è·                   | è‡ªåŠ¨æ•è·                   | éœ€æ‰‹åŠ¨ `set_exception()`   |
| **é€‚ç”¨åœºæ™¯**             | ç®€å•å¼‚æ­¥ä»»åŠ¡               | ä»»åŠ¡é˜Ÿåˆ—/çº¿ç¨‹æ±             | å¤æ‚åŒæ­¥/è·¨æ¨¡å—é€šä¿¡        |
| **å¯é‡ç”¨æ€§**             | âŒï¼ˆå•æ¬¡ä½¿ç”¨ï¼‰              | âœ…ï¼ˆéœ€é‡å»ºï¼‰                | âœ…ï¼ˆä½†éœ€è°¨æ…ï¼‰              |
| **ç»“æœç”Ÿäº§è€…-æ¶ˆè´¹è€…å…³ç³»**| 1:1                        | 1:1                        | 1:1 æˆ– 1:Nï¼ˆé€šè¿‡å…±äº« futureï¼‰|

---

### ç”Ÿå‘½å‘¨æœŸå¯¹æ¯”
```mermaid
graph TD
    subgraph async
    A[åˆ›å»º async] --> B[è‡ªåŠ¨å¯åŠ¨çº¿ç¨‹]
    B --> C[è‡ªåŠ¨è®¾ç½®ç»“æœåˆ° future]
    end

    subgraph packaged_task
    D[åˆ›å»º packaged_task] --> E[æ‰‹åŠ¨ä¼ é€’/å­˜å‚¨]
    E --> F[è°ƒç”¨ä»»åŠ¡æ—¶è®¾ç½®ç»“æœ]
    end

    subgraph promise
    G[åˆ›å»º promise] --> H[è·å–å…³è” future]
    H --> I[ä»»æ„ä½ç½®æ‰‹åŠ¨è®¾ç½®ç»“æœ]
    end
```

---

### å¦‚ä½•é€‰æ‹©ï¼Ÿ
1. **é¦–é€‰ `std::async`**  
   å½“éœ€è¦ç®€å•æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œä¸å…³å¿ƒçº¿ç¨‹ç®¡ç†ç»†èŠ‚æ—¶

2. **é€‰æ‹© `std::packaged_task`**  
   å½“éœ€è¦ï¼š
   - å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—
   - æ§åˆ¶ä»»åŠ¡æ‰§è¡Œæ—¶æœº
   - é‡ç”¨ä»»åŠ¡æ¨¡æ¿

3. **é€‰æ‹© `std::promise`**  
   å½“éœ€è¦ï¼š
   - åœ¨éç›´æ¥å…³è”çš„ä»£ç ä½ç½®è®¾ç½®ç»“æœ
   - å®ç°å¤æ‚åŒæ­¥æœºåˆ¶
   - è·¨æ¨¡å—/ç»„ä»¶é€šä¿¡
   - æ‰‹åŠ¨æ§åˆ¶å¼‚å¸¸ä¼ é€’

> ğŸ’¡ **é»„é‡‘æ³•åˆ™**ï¼šä¼˜å…ˆä½¿ç”¨é«˜å±‚æŠ½è±¡ï¼ˆasyncï¼‰ï¼Œå½“éœ€è¦æ›´ç²¾ç»†æ§åˆ¶æ—¶é™çº§ä½¿ç”¨ï¼ˆpackaged_task â†’ promiseï¼‰

---

### ç»„åˆä½¿ç”¨ç¤ºä¾‹
ä¸‰è€…å¯ååŒå·¥ä½œï¼š
```cpp
// ä½¿ç”¨ promise æ§åˆ¶å¤æ‚æµç¨‹
std::promise<void> ready_promise;

// ç”¨ packaged_task åŒ…è£…ä»»åŠ¡
std::packaged_task<void()> task([&] {
    ready_promise.set_value();  // é€šçŸ¥å‡†å¤‡å°±ç»ª
    // ... æ‰§è¡Œä»»åŠ¡ ...
});

auto fut = ready_promise.get_future();
std::thread t(std::move(task));

// ç”¨ async ç­‰å¾…å‡†å¤‡ä¿¡å·
auto async_fut = std::async(std::launch::async, [&] {
    fut.wait();  // ç­‰å¾…å°±ç»ªä¿¡å·
    // ... åç»­å¤„ç† ...
});

t.join();
async_fut.get();
```

è¿™ç§ç»„åˆæä¾›äº†æœ€å¤§çµæ´»æ€§ï¼ŒåŒæ—¶ä¿æŒäº†ä»£ç çš„æ¸…æ™°æ€§ã€‚